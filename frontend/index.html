<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <link href="../css/weather-icons.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.28.5/date_fns.min.js"></script>
  <script src="./marcel.js"></script>
</head>

<body>
  <p id="season"></p>
  <i id="icon" class="wi wi-night-sleet"></i>
  <p id="content"></p>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    i {
      font-size: 5em;
      font-size: 25vw;
    }

    p {
      font-size: 5em;
      font-size: 10vw;
      margin: .3em;
    }

    #season {
      margin-bottom: 2em;
    }
  </style>

  <script>
    const { isToday, closestTo, isEqual } = dateFns
    class Text extends Marcel.Plugin {
      constructor() {
        super({
          defaultProps: {
            text: '',
            textAlign: 'center',
            stylesvar: {}
          },
        })

        this.temperature = document.getElementById('content')
        this.icon = document.getElementById('icon')
        this.season = document.getElementById('season')
      }

      mapIcon = key =>
        ({
          8: 'wi-day-sunny',
          2: 'wi-day-thunderstorm',
          3: 'wi-day-rain',
          5: 'wi-day-rain',
          6: 'wi-day-snow',
          7: 'wi-day-cloudy',
          9: 'wi-day-cloudy'
        }[key] || 'wi-day-sunny')

      parse(date, data, checkDayFn) {
        const closestDate = closestTo(date, data.list.map(e => e.dt_txt))
        const closestData = data.list.find(e => isEqual(e.dt_txt, closestDate))

        const [weather] = closestData.weather
        let iconKey = `${weather.id}`.substr(0, 1)
        if (iconKey === 8 && weather.id > 800) {
          iconKey = 9
        }

        return {
          icon: this.mapIcon(iconKey),
          temperature: `${this.formatNumber(closestData.main.temp)}° C`,
        }
      }

      formatNumber = new Intl.NumberFormat('fr-FR', {
        maximumSignificantDigits: 2
      }).format

      async loadWeather() {
        const response = await fetch(
          `https://api.openweathermap.org/data/2.5/forecast?id=${this.props.city}&units=metric&appid=${this.props.apiKey}`
        )
        if (!response.ok) throw Error('Invalid server response', response)

        const data = await response.json()
        const today = new Date()

        return {
          city: data.city.name,
          today: this.parse(today, data, isToday),
        }
      }

      getSeason() {
        const date = new Date()
        const month = date.getMonth()
        if (3 <= month <= 5) {
            return 'le printemps'
        }

        if (6 <= month <= 8) {
            return "l'été"
        }

        if (9 <= month <= 11) {
            return "l'automne"
        }

        // Months 12, 01, 02
        return "l'hiver"
      }

      async update() {
        if (!this.props.city || !this.props.apiKey) return
        const response = await this.loadWeather()
        this.icon.className = `wi ${response.today.icon}`
        this.temperature.innerText = response.today.temperature
        this.season.innerText = `C'est ${this.getSeason()}`
      }

      propsDidChange() {
        this.update()
      }

      render() {
        if (!this.interval) {
          this.interval = setInterval(this.update, 1000 * 60 * 60)
        }

        const { text, stylesvar, color } = this.props

        if (stylesvar['primary-color']) this.temperature.style.color = stylesvar['primary-color']
        if (stylesvar['font-family']) this.temperature.style.fontFamily = stylesvar['font-family']

        if (stylesvar['primary-color']) this.season.style.color = stylesvar['primary-color']
        if (stylesvar['font-family']) this.season.style.fontFamily = stylesvar['font-family']

        if (stylesvar['primary-color']) this.icon.style.color = stylesvar['primary-color']
      }
    }

    const instance = new Text()
  </script>
</body>
